<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Intrigued Mutts Merch</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">

<style>
/* ===== SAME CSS YOU HAD ===== */
html,body{margin:0;font-family:system-ui;background:linear-gradient(rgba(0,0,0,.68),rgba(0,0,0,.68)),url('merchbackground.png') center/cover no-repeat fixed;color:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:20px}
.card{border:1px solid #444;padding:14px;border-radius:12px;background:#111}
.imgWrap{height:180px;display:flex;align-items:center;justify-content:center}
.imgWrap img{max-height:100%;object-fit:contain}
.btnGlow{background:transparent;border:1px solid #3aa0ff;padding:10px 16px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;transition:all 0.2s ease;box-shadow:0 0 14px rgba(58,160,255,0.45);text-decoration:none;display:inline-block}
.btnGlow:hover{transform:translateY(-2px);box-shadow:0 0 20px rgba(58,160,255,0.75);background:rgba(58,160,255,0.08)}
.btnGlow:active{transform:translateY(0);box-shadow:0 0 14px rgba(58,160,255,0.55)}
.buyBtn{background:transparent;border:1px solid #3aa0ff;padding:12px 20px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;transition:all 0.2s ease;box-shadow:0 0 16px rgba(58,160,255,0.5)}
.buyBtn:hover{transform:translateY(-2px);box-shadow:0 0 22px rgba(58,160,255,0.85);background:rgba(58,160,255,0.08)}
.buyBtn:active{transform:translateY(0)}
#modalBuyBtn,#closeModal{margin-top:12px;min-width:120px}
#modalBuyBtn{margin-right:8px}
.modalBack{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:9999}
.modal{background:#111;padding:24px;border-radius:14px;max-width:900px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
.modal h2{margin-top:0;margin-bottom:16px}
.variantRow{cursor:pointer;padding:12px;border-bottom:1px solid #333;transition:background 0.2s ease}
.variantRow:hover{background:rgba(58,160,255,0.15)}
</style>
</head>

<body>

<div style="max-width:1100px;margin:auto;padding:24px">

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
  <h1 style="margin:0">Intrigued Mutts Collection</h1>
  <div style="display:flex;gap:10px">
    <button id="refreshBtn" class="btnGlow">Refresh products</button>
    <a href="./index.html#mancave" class="btnGlow">← Back to Clubhouse</a>
  </div>
</div>

<div id="statusText"></div>
<div id="grid" class="grid"></div>

<div style="margin-top:40px;padding-top:24px;border-top:1px solid #333;text-align:center;font-size:13px;color:#ff69b4">
  © 2026 Intrigued Mutts Society. All rights reserved.
</div>

</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack">
<div class="modal">
<h2 id="modalTitle"></h2>
<img id="modalImg" style="max-height:300px">

<div id="variantNote" style="margin-bottom:12px;font-size:14px;color:#aaa"></div>
<div id="variantList" style="margin-bottom:16px"></div>

<button class="buyBtn" id="modalBuyBtn">Buy</button>
<button id="closeModal" class="btnGlow">Close</button>
</div>
</div>

<script>

const API_BASE = "https://mutts-api.redavi19.workers.dev";

const grid = document.getElementById("grid");
const statusText = document.getElementById("statusText");
const refreshBtn = document.getElementById("refreshBtn");

const modalBack = document.getElementById("modalBack");
const modalTitle = document.getElementById("modalTitle");
const modalImg = document.getElementById("modalImg");
const modalBuyBtn = document.getElementById("modalBuyBtn");
const closeModal = document.getElementById("closeModal");
const loadVariantsBtn = document.getElementById("loadVariantsBtn");
const variantList = document.getElementById("variantList");
const variantNote = document.getElementById("variantNote");

let allProducts = [];
let activeProduct = null;
let activeVariant = null;

/* ================================
   ✅ FIXED CHECKOUT FUNCTION
================================ */

async function createCheckoutLink(name, amountCents) {

  const res = await fetch(`${API_BASE}/api/checkout/create`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, amount: amountCents })
  });

  const data = await res.json();

  console.log("Square response:", data);

  const url =
    data?.checkoutUrl ||
    data?.raw?.payment_link?.url ||
    data?.raw?.payment_link?.long_url ||
    data?.payment_link?.url ||
    data?.payment_link?.long_url;

  if (!url) {
    alert("Checkout link not returned. Check console.");
    return;
  }

  window.location.href = url;
}

/* ============================= */

async function loadProducts() {

  statusText.textContent = "Loading products...";
  grid.innerHTML = "";

  const res = await fetch(`${API_BASE}/api/store/products`);
  const data = await res.json();

  allProducts = data?.result || [];

  render();
}

function render() {

  statusText.textContent = `Loaded ${allProducts.length} products`;

  grid.innerHTML = "";

  allProducts.forEach(prod => {

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="imgWrap">
        <img src="${prod.thumbnail_url}">
      </div>
      <h3>${prod.name}</h3>
      <button class="buyBtn">Buy</button>
    `;

    const buyBtn = card.querySelector(".buyBtn");

    buyBtn.onclick = (e) => {
      e.stopPropagation();
      openModal(prod);
    };

    card.onclick = () => openModal(prod);

    grid.appendChild(card);

  });
}

/* ===== MODAL ===== */

async function openModal(prod){

  activeProduct = prod;
  modalTitle.textContent = prod.name;
  modalImg.src = prod.thumbnail_url;

  variantList.innerHTML = "";
  variantNote.textContent = "Loading sizes...";
  modalBack.style.display = "flex";
  
  // Auto-load variants
  await loadVariants();
}

async function loadVariants() {
  if (!activeProduct) return;
  
  try {
    const res = await fetch(`${API_BASE}/api/store/products/${activeProduct.id}`);
    const data = await res.json();
    const variants = data?.result?.sync_variants || [];
    
    variantList.innerHTML = "";
    
    if (!variants.length) {
      variantNote.textContent = "No sizes available for this product.";
      return;
    }
    
    variantNote.textContent = "Pick your size:";
    
    variants.forEach(v => {
      const row = document.createElement("div");
      row.className = "variantRow";
      row.textContent = `${v.name} - $${v.retail_price}`;
      
      row.onclick = () => {
        activeVariant = v;
        const cents = Math.round(Number(v.retail_price) * 100);
        modalBuyBtn.textContent = `Buy - $${v.retail_price}`;
        modalBuyBtn.onclick = async () => {
          await createCheckoutLink(
            `${activeProduct.name} - ${v.name}`,
            cents
          );
        };
      };
      
      variantList.appendChild(row);
    });
  } catch (e) {
    console.error(e);
    variantNote.textContent = "Could not load sizes. Try again.";
  }
}

closeModal.onclick = () => modalBack.style.display = "none";

modalBuyBtn.textContent = "Buy";

refreshBtn.onclick = loadProducts;

loadProducts();

</script>

</body>
</html>
