<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Intrigued Mutts Merch</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet" media="print" onload="this.media='all'">

<style>
html,body{margin:0;font-family:system-ui;background:linear-gradient(rgba(0,0,0,.68),rgba(0,0,0,.68)),url('merchbackground.png') center/cover no-repeat fixed;color:#fff}
.pageShell{max-width:1100px;margin:auto;padding:24px}
.topBar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;flex-wrap:wrap}
.topActions{display:flex;gap:10px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:20px}
.card{border:1px solid #444;padding:14px;border-radius:12px;background:rgba(17,17,17,0.35);backdrop-filter:blur(10px)}
.imgWrap{height:180px;display:flex;align-items:center;justify-content:center;background:#222;border-radius:12px;overflow:hidden;border:1px solid #333}
.imgWrap img{max-height:100%;object-fit:contain;opacity:0;transition:opacity 0.3s ease}
.imgWrap img.loaded{opacity:1}

.btnGlow{background:transparent;border:1px solid #3aa0ff;padding:10px 16px;border-radius:10px;color:#fff;font-weight:800;cursor:pointer;transition:all 0.2s ease;box-shadow:0 0 10px rgba(58,160,255,0.28);text-decoration:none;display:inline-block}
.btnGlow:hover{transform:translateY(-2px);box-shadow:0 0 14px rgba(58,160,255,0.45);background:rgba(58,160,255,0.06)}
.btnGlow:active{transform:translateY(0);box-shadow:0 0 10px rgba(58,160,255,0.35)}

.buyBtn{background:transparent;border:1px solid #3aa0ff;padding:12px 20px;border-radius:10px;color:#fff;font-weight:900;cursor:pointer;transition:all 0.2s ease;box-shadow:0 0 12px rgba(58,160,255,0.32)}
.buyBtn:hover{transform:translateY(-2px);box-shadow:0 0 16px rgba(58,160,255,0.5);background:rgba(58,160,255,0.06)}
.buyBtn:active{transform:translateY(0)}
#modalBuyBtn,#closeModal{margin-top:12px;min-width:120px}
#modalBuyBtn{margin-right:8px}
.modalBack{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:9999;padding:12px}
.modal{background:#111;padding:24px;border-radius:14px;max-width:900px;width:100%;max-height:92vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
.modal h2{margin-top:0;margin-bottom:16px}
.variantRow{cursor:pointer;padding:12px;border-bottom:1px solid #333;transition:background 0.2s ease;border-radius:10px}
.variantRow:hover{background:rgba(58,160,255,0.15)}

/* ===== CART DRAWER ===== */
.cartBtn {
  background:transparent;border:1px solid #3aa0ff;padding:10px 16px;border-radius:10px;
  color:#fff;font-weight:900;cursor:pointer;transition:all .2s ease;
  box-shadow:0 0 10px rgba(58,160,255,.28);
}
.cartBtn:hover{transform:translateY(-2px);box-shadow:0 0 14px rgba(58,160,255,.45);background:rgba(58,160,255,.06)}
.cartBadge{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:22px;height:22px;padding:0 6px;border-radius:999px;
  margin-left:8px;font-size:12px;font-weight:900;
  background:rgba(58,160,255,.25);border:1px solid rgba(58,160,255,.65);
  box-shadow:0 0 12px rgba(58,160,255,.35);
}

.cartBack{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
  z-index:10000;
}
.cartDrawer{
  position:absolute;right:0;top:0;height:100%;width:min(420px, 92vw);
  background:rgba(17,17,17,.92);backdrop-filter: blur(12px);
  border-left:1px solid #333;
  box-shadow:-20px 0 60px rgba(0,0,0,.8);
  padding:16px;
  display:flex;flex-direction:column;
}
.cartHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.cartHeader h2{margin:0}
.cartItems{flex:1;overflow:auto;padding-right:4px}
.cartItem{
  display:grid;grid-template-columns:64px 1fr auto;gap:10px;
  padding:10px;border:1px solid #333;border-radius:12px;
  background:rgba(0,0,0,.25);
  margin-bottom:10px;
}
.cartItem img{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid #333}
.cartName{font-weight:900}
.cartMeta{font-size:12px;color:#aaa;margin-top:4px}
.cartQtyRow{display:flex;align-items:center;gap:8px;margin-top:8px}
.qtyBtn{
  width:32px;height:32px;border-radius:10px;border:1px solid #3aa0ff;background:transparent;color:#fff;
  font-weight:900;cursor:pointer;box-shadow:0 0 10px rgba(58,160,255,.18);
}
.qtyBtn:hover{background:rgba(58,160,255,.06)}
.qtyNum{min-width:24px;text-align:center;font-weight:900}
.removeBtn{
  border:1px solid #ff4d6d;background:transparent;color:#fff;border-radius:10px;
  padding:8px 10px;cursor:pointer;font-weight:900;
  box-shadow:0 0 10px rgba(255,77,109,.2);
}
.removeBtn:hover{background:rgba(255,77,109,.06)}
.cartFooter{
  border-top:1px solid #333;padding-top:12px;margin-top:12px;
}
.cartTotals{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.smallNote{font-size:12px;color:#aaa;line-height:1.35}
.checkoutBtn{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid #3aa0ff;background:transparent;color:#fff;
  font-weight:900;cursor:pointer;
  box-shadow:0 0 12px rgba(58,160,255,.32);
}
.checkoutBtn:hover{transform:translateY(-2px);box-shadow:0 0 16px rgba(58,160,255,.5);background:rgba(58,160,255,0.06)}
.checkoutBtn:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* ===== LIGHTBOX ===== */
.lightboxBack{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:99999;
  justify-content:center;align-items:center;cursor:zoom-out;
}
.lightboxBack img{
  max-width:95vw;max-height:95vh;object-fit:contain;
  box-shadow:0 20px 80px rgba(0,0,0,0.9);
}

/* ===== SHIPPING MODAL ===== */
.shipBack{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);
  justify-content:center;align-items:center;z-index:20000;padding:12px;
}
.shipModal{
  width:min(640px, 96vw);
  background:rgba(17,17,17,.95);
  backdrop-filter: blur(12px);
  border:1px solid #333;
  border-radius:16px;
  box-shadow:0 20px 70px rgba(0,0,0,.85);
  padding:18px;
}
.shipTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
.shipTop h2{margin:0}
.shipGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}
.shipGrid .full{grid-column:1 / -1}
.field label{display:block;font-size:12px;color:#aaa;margin:0 0 6px 2px}
.field input, .field select{
  width:100%;
  background:rgba(0,0,0,.25);
  border:1px solid #333;
  border-radius:12px;
  padding:12px 12px;
  color:#fff;
  outline:none;
}
.field input:focus, .field select:focus{
  border-color:rgba(58,160,255,.8);
  box-shadow:0 0 0 3px rgba(58,160,255,.15);
}
.shipActions{
  display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px;
}
.shipHint{font-size:12px;color:#aaa;line-height:1.35;margin-top:8px}
.pill{
  display:inline-block;
  border:1px solid rgba(58,160,255,.55);
  background:rgba(58,160,255,.12);
  color:#cfe9ff;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
}
.inlineRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.divider{height:1px;background:#2a2a2a;margin:10px 0}

/* Loading spinner */
.spinner{
  border:3px solid rgba(58,160,255,0.2);
  border-top:3px solid #3aa0ff;
  border-radius:50%;
  width:40px;height:40px;
  animation:spin 1s linear infinite;
  margin:20px auto;
}
@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

/* Responsive tweaks for mobile */
@media (max-width: 720px){
  .pageShell{padding:16px}
  .topBar{flex-direction:column;align-items:flex-start}
  .topActions{width:100%}
  .topActions .btnGlow,.topActions .cartBtn{width:100%;text-align:center}
  h1{font-size:28px}
  .card{padding:12px}
  .imgWrap{height:160px}
  .cartDrawer{width:min(390px, calc(100vw - 18px));max-width:100%;border-left:none;padding:14px;right:0;left:auto;box-shadow:-10px 0 40px rgba(0,0,0,.75)}
  .modal{max-width:520px;width:100%;max-height:86vh;padding:18px}
  #modalImg{max-height:200px;width:auto;max-width:100%}
  #modalBuyBtn,#closeModal{width:100%;margin-right:0}
  .shipGrid{grid-template-columns:1fr}
}

/* tiny footer link */
a { color: inherit; }
code { color: #cfe9ff; }
</style>
</head>

<body>

<div class="pageShell">

  <div class="topBar">
    <h1 style="margin:0">Intrigued Mutts Collection</h1>
    <div class="topActions">
      <button id="refreshBtn" class="btnGlow">Refresh products</button>
      <button id="shippingBtn" class="btnGlow">Shipping</button>
      <a href="./index.html#mancave" class="btnGlow">← Back to Clubhouse</a>
    </div>
  </div>

  <div id="statusText"></div>
  <div id="grid" class="grid"></div>

  <div style="margin-top:40px;padding-top:24px;border-top:1px solid #333;text-align:center">
    <a href="./index.html#mancave" class="btnGlow">← Back to Clubhouse</a>
    <div style="margin-top:16px;font-size:13px;color:#ff69b4">
      © 2026 Intrigued Mutts Society. All rights reserved.
    </div>
  </div>

</div>

<!-- PRODUCT MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <h2 id="modalTitle"></h2>

    <div style="display:flex;justify-content:center;align-items:center;margin:16px 0">
      <img id="modalImg" style="max-height:300px;cursor:pointer;transition:transform 0.2s ease" 
          title="Click to view full size"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'">
    </div>

    <div id="enlargeLabel" style="text-align:center;font-size:12px;color:#3aa0ff;margin-top:8px;margin-bottom:12px">
      ✨ Click to enlarge
    </div>

    <div id="variantNote" style="margin-bottom:12px;font-size:14px;color:#aaa"></div>
    <div id="variantList" style="margin-bottom:16px"></div>

    <button class="buyBtn" id="modalBuyBtn">Add to Cart</button>
    <button id="closeModal" class="btnGlow">Close</button>
  </div>
</div>

<!-- LIGHTBOX FOR ENLARGED IMAGE -->
<div class="lightboxBack" id="lightboxBack">
  <img id="lightboxImg" src="" alt="">
</div>

<!-- CART DRAWER -->
<div class="cartBack" id="cartBack">
  <div class="cartDrawer">
    <div class="cartHeader">
      <h2>Cart</h2>
      <button class="btnGlow" id="closeCartBtn">Close</button>
    </div>

    <div class="inlineRow" style="margin:6px 0 10px">
      <span class="pill" id="shipStatusPill">Shipping: Not set</span>
      <button class="btnGlow" id="editShippingFromCartBtn" style="padding:8px 12px">Edit</button>
    </div>

    <div class="cartItems" id="cartItems"></div>

    <div class="cartFooter">
      <div class="cartTotals">
        <div style="font-weight:900">Subtotal</div>
        <div style="font-weight:900" id="cartSubtotal">$0.00</div>
      </div>

      <div class="cartTotals" style="opacity:.9">
        <div>Shipping (est.)</div>
        <div id="cartShip">$—</div>
      </div>

      <div class="cartTotals" style="opacity:.9">
        <div>Tax (est.)</div>
        <div id="cartTax">$—</div>
      </div>

      <div class="cartTotals" style="margin-top:8px;border-top:1px solid #333;padding-top:10px">
        <div style="font-weight:900">Estimated Total</div>
        <div style="font-weight:900" id="cartTotal">$—</div>
      </div>

      <div class="smallNote" style="margin-top:8px">
        Final total is confirmed in PayPal.
      </div>

      <div class="smallNote" id="paypalTotalNote" style="margin-top:6px;display:none">
        PayPal total: $0.00
      </div>

      <button class="checkoutBtn" id="checkoutBtn">Checkout (PayPal)</button>

      <div class="smallNote" style="margin-top:10px">
        Shipping + tax are calculated before PayPal using Printful estimate-costs. You'll approve the total in PayPal.
      </div>
    </div>
  </div>
</div>

<!-- SHIPPING MODAL -->
<div class="shipBack" id="shipBack">
  <div class="shipModal">
    <div class="shipTop">
      <h2>Shipping details</h2>
      <button class="btnGlow" id="shipCloseBtn">Close</button>
    </div>

    <div class="divider"></div>

    <div class="inlineRow">
      <span class="pill" id="shipModePill">Saved: No</span>
      <span style="font-size:12px;color:#aaa">We store this on your device only (localStorage).</span>
    </div>

    <div class="shipGrid" style="margin-top:12px">
      <div class="field full">
        <label for="shipName">Full name</label>
        <input id="shipName" autocomplete="name" placeholder="First Last">
      </div>

      <div class="field full">
        <label for="shipAddress1">Street address</label>
        <input id="shipAddress1" autocomplete="address-line1" placeholder="123 Main St">
      </div>

      <div class="field full">
        <label for="shipAddress2">Apt / Unit (optional)</label>
        <input id="shipAddress2" autocomplete="address-line2" placeholder="Apt 4B">
      </div>

      <div class="field">
        <label for="shipCity">City</label>
        <input id="shipCity" autocomplete="address-level2" placeholder="Rockville">
      </div>

      <div class="field">
        <label for="shipState">State</label>
        <input id="shipState" maxlength="2" autocomplete="address-level1" placeholder="MD">
      </div>

      <div class="field">
        <label for="shipZip">ZIP</label>
        <input id="shipZip" inputmode="numeric" autocomplete="postal-code" placeholder="20852">
      </div>

      <div class="field">
        <label for="shipCountry">Country</label>
        <select id="shipCountry" autocomplete="country">
          <option value="US">US</option>
          <option value="CA">CA</option>
          <option value="GB">GB</option>
          <option value="AU">AU</option>
          <option value="FR">FR</option>
          <option value="DE">DE</option>
        </select>
      </div>
    </div>

    <div class="shipHint">
      This info is required so Printful can estimate shipping + tax accurately before PayPal.
    </div>

    <div class="shipActions">
      <button class="btnGlow" id="shipClearBtn" style="border-color:#ff4d6d;box-shadow:0 0 10px rgba(255,77,109,.2)">Clear</button>
      <button class="btnGlow" id="shipSaveBtn">Save shipping</button>
      <button class="buyBtn" id="shipSaveAndCheckoutBtn">Save + Continue to PayPal</button>
    </div>
  </div>
</div>

<script>
// ===============================
// 1) Store API (for listing products/variants)
// ===============================
const WORKER_BASE = "https://mutts-paypal.ryanedavis.workers.dev".replace(/\/$/, "");
const STORE_API_BASE = WORKER_BASE;

// ===============================
// 2) PayPal Worker (for payment)
// ===============================
const PAYPAL_WORKER_BASE = WORKER_BASE;

// IMPORTANT: Put YOUR real API key here (the Worker secret you created).
// For sandbox/testing it is okay to place it here.
// Later we can hide it properly.
const API_KEY = "mutts_api_7f3a91c2b8e4d0aa55c9";

// Timeout helper
function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("Request timeout")), timeoutMs)
    )
  ]);
}

const USE_MOCK_DATA = false; // Set true for offline testing
const grid = document.getElementById("grid");
const statusText = document.getElementById("statusText");
const refreshBtn = document.getElementById("refreshBtn");
const shippingBtn = document.getElementById("shippingBtn");

const modalBack = document.getElementById("modalBack");
const modalTitle = document.getElementById("modalTitle");
const modalImg = document.getElementById("modalImg");
const modalBuyBtn = document.getElementById("modalBuyBtn");
const closeModal = document.getElementById("closeModal");
const variantList = document.getElementById("variantList");
const variantNote = document.getElementById("variantNote");

// Cart drawer DOM
const cartBack = document.getElementById("cartBack");
const closeCartBtn = document.getElementById("closeCartBtn");
const cartItemsEl = document.getElementById("cartItems");
const cartSubtotalEl = document.getElementById("cartSubtotal");
const cartShipEl = document.getElementById("cartShip");
const cartTaxEl = document.getElementById("cartTax");
const cartTotalEl = document.getElementById("cartTotal");
const paypalTotalNote = document.getElementById("paypalTotalNote");
const checkoutBtn = document.getElementById("checkoutBtn");
const editShippingFromCartBtn = document.getElementById("editShippingFromCartBtn");
const shipStatusPill = document.getElementById("shipStatusPill");

// Lightbox elements
const lightboxBack = document.getElementById("lightboxBack");
const lightboxImg = document.getElementById("lightboxImg");

// Shipping modal elements
const shipBack = document.getElementById("shipBack");
const shipCloseBtn = document.getElementById("shipCloseBtn");
const shipClearBtn = document.getElementById("shipClearBtn");
const shipSaveBtn = document.getElementById("shipSaveBtn");
const shipSaveAndCheckoutBtn = document.getElementById("shipSaveAndCheckoutBtn");
const shipModePill = document.getElementById("shipModePill");

const shipName = document.getElementById("shipName");
const shipAddress1 = document.getElementById("shipAddress1");
const shipAddress2 = document.getElementById("shipAddress2");
const shipCity = document.getElementById("shipCity");
const shipState = document.getElementById("shipState");
const shipZip = document.getElementById("shipZip");
const shipCountry = document.getElementById("shipCountry");

// We will inject a Cart button into the header actions container
const headerRight = document.querySelector(".topActions") || document.querySelector(".topBar");
let cartBtn;

// Ensure browser back navigates to clubhouse landing
function redirectToClubhouse(){
  window.location.href = "./index.html#mancave";
}
history.pushState({ page: "merch" }, "", window.location.href);
window.addEventListener("popstate", () => redirectToClubhouse());

// ===============================
// State
// ===============================
let allProducts = [];
let activeProduct = null;
const variantCache = {}; // Cache variants by product ID

// ===============================
// CART (localStorage)
// ===============================
const CART_KEY = "mutts_cart_v1";

function getCart() {
  try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
  catch { return []; }
}

function saveCart(cart) {
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
  updateCartBadge();
  updateShippingPills();
}

function cartCount(cart = getCart()) {
  return cart.reduce((sum, it) => sum + (Number(it.qty) || 0), 0);
}

function money(n) {
  const v = Number(n || 0);
  return "$" + v.toFixed(2);
}

function calcSubtotal(cart = getCart()) {
  return cart.reduce((sum, it) => {
    const unit = Number(it.unitPrice || 0);
    const qty = Number(it.qty || 0);
    return sum + unit * qty;
  }, 0);
}

function makeLineId(productId, variantId) {
  return `${productId}::${variantId}`;
}

function addToCart(item) {
  const cart = getCart();
  const id = item.lineId;

  const existing = cart.find(x => x.lineId === id);
  if (existing) existing.qty += item.qty;
  else cart.push(item);

  saveCart(cart);
  renderCart();
  openCart();
}

function changeQty(lineId, delta) {
  const cart = getCart();
  const it = cart.find(x => x.lineId === lineId);
  if (!it) return;
  it.qty = Math.max(1, (Number(it.qty) || 1) + delta);
  saveCart(cart);
  renderCart();
}

function openProductFromCart(cartItem) {
  const prod = allProducts.find(p => String(p.id) === String(cartItem.productId));
  const fallbackProd = prod || {
    id: cartItem.productId,
    name: cartItem.productName || "Item",
    thumbnail_url: cartItem.imageUrl,
  };

  closeCart();
  openModal(fallbackProd);
}

function removeFromCart(lineId) {
  let cart = getCart();
  cart = cart.filter(x => x.lineId !== lineId);
  saveCart(cart);
  renderCart();
}

function ensureCartButton() {
  if (!headerRight) return;
  if (cartBtn) return;

  cartBtn = document.createElement("button");
  cartBtn.className = "cartBtn";
  cartBtn.id = "cartBtn";
  cartBtn.innerHTML = `Cart <span class="cartBadge" id="cartBadge">0</span>`;
  cartBtn.onclick = openCart;

  headerRight.insertBefore(cartBtn, headerRight.firstChild);
  updateCartBadge();
}

function updateCartBadge() {
  const badge = document.getElementById("cartBadge");
  if (!badge) return;
  badge.textContent = String(cartCount());
}

function openCart() {
  renderCart();
  cartBack.style.display = "block";
  estimateCartTotals();
}

function closeCart() {
  cartBack.style.display = "none";
}

function renderCart() {
  const cart = getCart();
  cartItemsEl.innerHTML = "";

  if (!cart.length) {
    cartItemsEl.innerHTML = `
      <div style="padding:14px;border:1px dashed #444;border-radius:12px;color:#aaa">
        Your cart is empty. Add a size from any product.
      </div>
    `;
    cartSubtotalEl.textContent = "$0.00";
    checkoutBtn.disabled = true;
    return;
  }

  cart.forEach(it => {
    const row = document.createElement("div");
    row.className = "cartItem";

    row.innerHTML = `
      <img src="${it.imageUrl || ""}" alt="" loading="lazy" data-act="openItem" style="cursor:pointer">
      <div>
        <div class="cartName" data-act="openItem" style="cursor:pointer;text-decoration:underline;">
          ${it.productName || "Item"}
        </div>
        <div class="cartMeta">${it.variantName || ""}</div>
        <div class="cartMeta">Unit: ${money(it.unitPrice)}</div>

        <div class="cartQtyRow">
          <button class="qtyBtn" data-act="dec">−</button>
          <div class="qtyNum">${it.qty}</div>
          <button class="qtyBtn" data-act="inc">+</button>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:10px">
        <div style="font-weight:900">${money(Number(it.unitPrice) * Number(it.qty))}</div>
        <button class="removeBtn" data-act="remove">Remove</button>
      </div>
    `;

    row.querySelector("[data-act='dec']").onclick = () => changeQty(it.lineId, -1);
    row.querySelector("[data-act='inc']").onclick = () => changeQty(it.lineId, +1);
    row.querySelector("[data-act='remove']").onclick = () => removeFromCart(it.lineId);
    row.querySelectorAll("[data-act='openItem']").forEach(el => {
      el.onclick = () => openProductFromCart(it);
    });

    cartItemsEl.appendChild(row);
  });

  const subtotal = calcSubtotal(cart);
  cartSubtotalEl.textContent = money(subtotal);
  checkoutBtn.disabled = false;

  estimateCartTotals();
}

// ===============================
// SHIPPING (Option A) - Pretty modal (no prompts)
// ===============================
const SHIPPING_KEY = "mutts_shipping_v1";

function getShipping() {
  try { return JSON.parse(localStorage.getItem(SHIPPING_KEY) || "null"); }
  catch { return null; }
}

function saveShipping(shipping) {
  localStorage.setItem(SHIPPING_KEY, JSON.stringify(shipping));
  updateShippingPills();
  estimateCartTotals();
}

function clearShipping() {
  localStorage.removeItem(SHIPPING_KEY);
  updateShippingPills();
}

function normalizeShippingForWorker(formObj) {
  return {
    name: String(formObj.name || "").trim(),
    address: {
      address1: String(formObj.address1 || "").trim(),
      address2: String(formObj.address2 || "").trim(),
      city: String(formObj.city || "").trim(),
      state_code: String(formObj.state_code || "").trim().toUpperCase(),
      zip: String(formObj.zip || "").trim(),
      country_code: String(formObj.country_code || "US").trim().toUpperCase(),
    },
  };
}

function shippingLooksValid(shipping) {
  if (!shipping || !shipping.address) return false;
  const a = shipping.address;
  return Boolean(
    (shipping.name || "").trim() &&
    (a.address1 || "").trim() &&
    (a.city || "").trim() &&
    (a.state_code || "").trim() &&
    (a.zip || "").trim() &&
    (a.country_code || "").trim()
  );
}

function fillShippingFormFromSaved() {
  const s = getShipping();
  if (!s || !s.address) {
    shipName.value = "";
    shipAddress1.value = "";
    shipAddress2.value = "";
    shipCity.value = "";
    shipState.value = "";
    shipZip.value = "";
    shipCountry.value = "US";
    shipModePill.textContent = "Saved: No";
    return;
  }

  shipName.value = s.name || "";
  shipAddress1.value = s.address.address1 || s.address.address_line_1 || "";
  shipAddress2.value = s.address.address2 || s.address.address_line_2 || "";
  shipCity.value = s.address.city || s.address.admin_area_2 || "";
  shipState.value = s.address.state_code || s.address.admin_area_1 || "";
  shipZip.value = s.address.zip || s.address.postal_code || "";
  shipCountry.value = (s.address.country_code || "US").toUpperCase();

  shipModePill.textContent = "Saved: Yes";
}

function openShippingModal() {
  fillShippingFormFromSaved();
  shipBack.style.display = "flex";
}

function closeShippingModal() {
  shipBack.style.display = "none";
}

function readShippingForm() {
  return normalizeShippingForWorker({
    name: shipName.value,
    address1: shipAddress1.value,
    address2: shipAddress2.value,
    city: shipCity.value,
    state_code: shipState.value,
    zip: shipZip.value,
    country_code: shipCountry.value,
  });
}

function validateAndSaveShipping(showAlerts = true) {
  const shipping = readShippingForm();

  if (!shippingLooksValid(shipping)) {
    if (showAlerts) alert("Please fill: name, address, city, state, zip, country.");
    return null;
  }

  // Normalize to the Worker's expected custom-shape keys
  saveShipping(shipping);
  shipModePill.textContent = "Saved: Yes";
  return shipping;
}

function updateShippingPills() {
  const s = getShipping();
  const ok = shippingLooksValid(s);
  if (shipStatusPill) shipStatusPill.textContent = ok ? "Shipping: Saved" : "Shipping: Not set";
  if (shippingBtn) shippingBtn.textContent = ok ? "Shipping (Saved)" : "Shipping";
}

// ensures we either have saved shipping or we open the modal
async function ensureShippingOrOpenModal() {
  const shipping = getShipping();
  if (shippingLooksValid(shipping)) return shipping;
  openShippingModal();
  return null;
}

// Estimate shipping/tax/total via Worker to preview costs before PayPal
async function estimateCartTotals() {
  const cart = getCart();
  cartShipEl.textContent = "$—";
  cartTaxEl.textContent = "$—";
  cartTotalEl.textContent = "$—";

  if (!cart.length) return;

  const shipping = getShipping();
  if (!shipping || !shipping.address) {
    cartShipEl.textContent = "Add shipping";
    cartTaxEl.textContent = "Add shipping";
    return;
  }

  try {
    // call Worker for Printful estimate
    const res = await fetchWithTimeout(`${PAYPAL_WORKER_BASE}/paypal/estimate`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-KEY": API_KEY,
      },
      body: JSON.stringify({
        currency: "USD",
        shipping,
        items: cart.map(it => ({
          syncVariantId: it.syncVariantId,
          qty: Number(it.qty || 1),
          unitPrice: String(Number(it.unitPrice || 0).toFixed(2)),
          productName: it.productName,
          variantName: it.variantName,
          imageUrl: it.imageUrl,
          productId: it.productId,
          catalogVariantId: it.catalogVariantId,
        })),
      }),
    }, 12000);

    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Estimate failed");

    cartShipEl.textContent = money(data.totals.shipping);
    cartTaxEl.textContent = money(data.totals.tax);
    cartTotalEl.textContent = money(data.totals.total);

  } catch (e) {
    console.log("estimateCartTotals error:", e);
  }
}

// ===============================
// PAYPAL CHECKOUT FOR WHOLE CART
// ===============================
async function checkoutCartWithPayPal() {
  const cart = getCart();
  if (!cart.length) return;

  // Ensure shipping exists; if not, open modal and stop
  const shipping = await ensureShippingOrOpenModal();
  if (!shipping) return;

  checkoutBtn.disabled = true;
  checkoutBtn.textContent = "Creating PayPal order...";

  try {
    const res = await fetchWithTimeout(`${PAYPAL_WORKER_BASE}/paypal/order`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-KEY": API_KEY,
      },
      body: JSON.stringify({
        currency: "USD",
        shipping,
        items: cart.map(it => ({
          productId: it.productId,
          productName: it.productName,
          variantName: it.variantName,
          imageUrl: it.imageUrl,
          unitPrice: String(Number(it.unitPrice).toFixed(2)),
          qty: Number(it.qty),

          // required by your Worker for Printful estimate + fulfillment
          syncVariantId: it.syncVariantId,
          catalogVariantId: it.catalogVariantId,
        })),
      }),
    }, 15000);

    if (!res.ok) throw new Error(`Server error: ${res.status} ${res.statusText}`);

    const data = await res.json();
    if (!data.ok || !data.approveUrl) {
      console.error("❌ PayPal order failed:", data);
      alert("PayPal order failed. Please try again.");
      return;
    }

    if (paypalTotalNote && data.totals && data.totals.total != null) {
      paypalTotalNote.textContent = `PayPal total: ${money(Number(data.totals.total))}`;
      paypalTotalNote.style.display = "block";
    }

    // straight to PayPal
    window.location.href = data.approveUrl;
  } catch (err) {
    console.error("❌ checkout error:", err);
    if (err.message === "Request timeout") {
      alert("Checkout timed out. Try again.");
    } else if (String(err.message || "").includes("Failed to fetch")) {
      alert("Cannot connect to payment service. Check your internet and try again.");
    } else {
      alert("Checkout failed: " + err.message);
    }
  } finally {
    checkoutBtn.disabled = false;
    checkoutBtn.textContent = "Checkout (PayPal)";
  }
}

// ===============================
// PRODUCTS
// ===============================
async function loadProducts() {
  statusText.innerHTML = '<div class="spinner"></div> Loading products...';
  statusText.style.color = "#3aa0ff";
  grid.innerHTML = "";

  try {
    const res = await fetchWithTimeout(`${STORE_API_BASE}/api/store/products`, {}, 10000);
    if (!res.ok) throw new Error(`Server error: ${res.status}`);

    const data = await res.json();
    allProducts = data?.result || [];
    renderProducts();
  } catch (err) {
    console.error("❌ Load products error:", err);
    statusText.style.color = "#ff4d6d";

    if (err.message === "Request timeout") {
      statusText.innerHTML = `⚠️ <strong>Loading timed out.</strong><br>
        The product service at <code style="font-size:11px">${STORE_API_BASE}</code> is not responding.<br>
        <button onclick="location.reload()" class="btnGlow" style="margin-top:10px">Retry</button>`;
    } else if (String(err.message || "").includes("Failed to fetch")) {
      statusText.innerHTML = `⚠️ <strong>Cannot connect to product service.</strong><br>
        Please check your internet connection or the API may be down.<br>
        <button onclick="location.reload()" class="btnGlow" style="margin-top:10px">Retry</button>`;
    } else {
      statusText.innerHTML = `⚠️ <strong>Failed to load products:</strong> ${err.message}<br>
        <button onclick="location.reload()" class="btnGlow" style="margin-top:10px">Retry</button>`;
    }
  }
}

function getProductImages(prod) {
  const urls = new Set();

  if (prod?.thumbnail_url) urls.add(prod.thumbnail_url);
  if (prod?.sync_product?.thumbnail_url) urls.add(prod.sync_product.thumbnail_url);

  if (Array.isArray(prod?.sync_variants)) {
    prod.sync_variants.forEach(v => {
      if (Array.isArray(v.files)) {
        v.files.forEach(f => {
          const url = f.preview_url || f.thumbnail_url;
          if (url) urls.add(url);
        });
      }
    });
  }
  return [...urls];
}

function renderProducts() {
  statusText.textContent = `Loaded ${allProducts.length} products`;
  statusText.style.color = "#cfe9ff";
  grid.innerHTML = "";

  allProducts.forEach(prod => {
    const card = document.createElement("div");
    card.className = "card";

    const thumb = prod.thumbnail_url || getProductImages(prod)[0] || "";

    card.innerHTML = `
      <div class="imgWrap">
        <img src="${thumb}" loading="lazy" onload="this.classList.add('loaded')">
      </div>
      <h3 style="margin:12px 0 10px">${prod.name}</h3>
      <button class="buyBtn">View sizes</button>
    `;

    card.querySelector(".buyBtn").onclick = (e) => {
      e.stopPropagation();
      openModal(prod);
    };

    card.onclick = () => openModal(prod);
    grid.appendChild(card);
  });
}

// ===============================
// MODAL + VARIANTS
// ===============================
async function openModal(prod){
  activeProduct = prod;

  // detail endpoint (more complete)
  try {
    const res = await fetchWithTimeout(`${STORE_API_BASE}/api/store/products/${prod.id}`, {}, 8000);
    if (res.ok) {
      const data = await res.json();
      activeProduct = { ...prod, ...(data?.result || {}) };
    }
  } catch (e) {
    console.log("Product detail fetch failed, using list data only.");
  }

  modalTitle.textContent = activeProduct.name;

  const images = getProductImages(activeProduct);
  activeProduct._images = images;

  modalImg.src = images[0] || activeProduct.thumbnail_url || "";
  modalImg.loading = "lazy";

  modalImg.onclick = () => {
    lightboxImg.src = modalImg.src;
    lightboxBack.style.display = "flex";
  };

  // thumbnails strip
  const oldStrip = document.getElementById("mockupStrip");
  if (oldStrip) oldStrip.remove();

  const strip = document.createElement("div");
  strip.id = "mockupStrip";
  strip.style.display = "flex";
  strip.style.gap = "8px";
  strip.style.justifyContent = "center";
  strip.style.flexWrap = "wrap";
  strip.style.margin = "10px 0 6px";

  images.forEach((url, idx) => {
    const t = document.createElement("img");
    t.src = url;
    t.loading = "lazy";
    t.style.width = "64px";
    t.style.height = "64px";
    t.style.objectFit = "cover";
    t.style.borderRadius = "10px";
    t.style.border = idx === 0 ? "2px solid rgba(58,160,255,.85)" : "1px solid #333";
    t.style.cursor = "pointer";
    t.onclick = () => {
      modalImg.src = url;
      [...strip.querySelectorAll("img")].forEach(im => im.style.border = "1px solid #333");
      t.style.border = "2px solid rgba(58,160,255,.85)";
    };
    strip.appendChild(t);
  });

  const enlargeLabel = document.getElementById("enlargeLabel");
  const imgContainer = modalImg.parentElement;
  if (enlargeLabel && imgContainer) {
    imgContainer.insertAdjacentElement("afterend", enlargeLabel);
    enlargeLabel.insertAdjacentElement("afterend", strip);
  } else {
    imgContainer.insertAdjacentElement("afterend", strip);
  }

  variantList.innerHTML = "";
  variantNote.textContent = "Loading sizes...";
  modalBack.style.display = "flex";

  await loadVariants();
}

async function loadVariants() {
  if (!activeProduct) return;

  try {
    let variants;

    if (variantCache[activeProduct.id]) {
      variants = variantCache[activeProduct.id];
    } else {
      const res = await fetchWithTimeout(`${STORE_API_BASE}/api/store/products/${activeProduct.id}`, {}, 8000);
      if (!res.ok) throw new Error(`Server error: ${res.status}`);
      const data = await res.json();
      variants = data?.result?.sync_variants || [];
      variantCache[activeProduct.id] = variants;
    }

    variantList.innerHTML = "";

    if (!variants.length) {
      variantNote.textContent = "No sizes available for this product.";
      return;
    }

    variantNote.textContent = "Pick your size:";
    modalBuyBtn.textContent = "Add to Cart";
    modalBuyBtn.disabled = true;

    variants.forEach(v => {
      const row = document.createElement("div");
      row.className = "variantRow";

      const price = Number(v.retail_price || 0).toFixed(2);

      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div>
            <div style="font-weight:900">${v.name}</div>
            <div style="font-size:13px;color:#aaa">$${price}</div>
          </div>
          <div style="font-size:12px;color:#aaa">Tap to select</div>
        </div>
      `;

      row.onclick = () => {
        [...variantList.children].forEach(el => el.style.outline = "none");
        row.style.outline = "2px solid rgba(58,160,255,.7)";

        modalBuyBtn.disabled = false;
        modalBuyBtn.textContent = `Add to Cart - $${price}`;

        modalBuyBtn.onclick = () => {
          const item = {
            lineId: makeLineId(activeProduct.id, v.id),
            productId: activeProduct.id,

            // SAVE BOTH:
            syncVariantId: Number(v.id),              // Printful sync variant id
            catalogVariantId: Number(v.variant_id),   // Printful catalog variant id

            productName: activeProduct.name,
            variantName: v.name,
            imageUrl: modalImg.src,
            unitPrice: Number(price),
            qty: 1,
          };
          addToCart(item);
        };
      };

      variantList.appendChild(row);
    });

  } catch (e) {
    console.error(e);
    if (e.message === "Request timeout") {
      variantNote.textContent = "⚠️ Loading sizes timed out. Please close and try again.";
    } else if (String(e.message || "").includes("Failed to fetch")) {
      variantNote.textContent = "⚠️ Cannot connect to service. Check your internet connection.";
    } else {
      variantNote.textContent = "⚠️ Could not load sizes: " + e.message;
    }
  }
}

// ===============================
// UI EVENTS
// ===============================
closeModal.onclick = () => modalBack.style.display = "none";
refreshBtn.onclick = loadProducts;

modalBack.onclick = (e) => { if (e.target === modalBack) modalBack.style.display = "none"; };

cartBack.onclick = (e) => { if (e.target === cartBack) closeCart(); };
closeCartBtn.onclick = closeCart;
checkoutBtn.onclick = checkoutCartWithPayPal;

shippingBtn.onclick = () => openShippingModal();
editShippingFromCartBtn.onclick = () => openShippingModal();

lightboxBack.onclick = () => { lightboxBack.style.display = "none"; };

// Shipping modal close on background click
shipBack.onclick = (e) => { if (e.target === shipBack) closeShippingModal(); };
shipCloseBtn.onclick = closeShippingModal;

shipClearBtn.onclick = () => {
  if (confirm("Clear saved shipping info on this device?")) {
    clearShipping();
    fillShippingFormFromSaved();
  }
};

shipSaveBtn.onclick = () => {
  const saved = validateAndSaveShipping(true);
  if (saved) {
    alert("Shipping saved.");
    closeShippingModal();
  }
};

shipSaveAndCheckoutBtn.onclick = async () => {
  const saved = validateAndSaveShipping(true);
  if (!saved) return;
  closeShippingModal();
  await checkoutCartWithPayPal();
};

// ===============================
// Boot
// ===============================
ensureCartButton();
renderCart();
updateShippingPills();
loadProducts();
</script>

</body>
</html>
