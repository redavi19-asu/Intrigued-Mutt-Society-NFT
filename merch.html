<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intrigued Mutts Merch</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#05060a;
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.16);
      --muted: rgba(255,255,255,.72);
      --text: #f7f9ff;

      --accent: rgba(120,180,255,.22);
      --accent2: rgba(255,140,120,.20);
      --shadow: 0 20px 40px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background: var(--bg0);
      overflow-x:hidden;
    }

    /* --- THEME BACKGROUND LAYERS --- */
    body::before{
      content:"";
      position:fixed; inset:0;
      z-index:-3;
      background:
        radial-gradient(circle at 20% 20%, rgba(120,180,255,.14), transparent 38%),
        radial-gradient(circle at 80% 10%, rgba(255,140,120,.12), transparent 40%),
        radial-gradient(circle at 50% 80%, rgba(180,255,200,.10), transparent 40%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 45%),
        #05060a;
    }

    /* Your character/logo layer (black & white vibe) */
    body::after{
      content:"";
      position:fixed; inset:0;
      z-index:-2;
      pointer-events:none;
      opacity:.22;
      background-image:
        url("./intrigued-mutts-society-transparent.png"),
        url("./intrigued-mutts-society-transparent.png");
      background-repeat: no-repeat, no-repeat;
      background-size: 520px auto, 520px auto;
      background-position: -40px 80px, calc(100% + 40px) 140px;
      filter: grayscale(1) contrast(1.15);
    }

    /* optional subtle texture from landing.png if you want it */
    .texture{
      position:fixed; inset:0;
      z-index:-1;
      pointer-events:none;
      opacity:.10;
      background:url("./landing.png") center/cover no-repeat;
      filter: grayscale(1) blur(1px) contrast(1.1);
      mix-blend-mode: screen;
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 26px 18px 60px;
    }

    .shell{
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow), 0 0 0 12px rgba(120,180,255,.04);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding: 22px 22px 10px;
    }

    .titleRow{
      display:flex;
      align-items:flex-start;
      gap:12px;
      min-width: 0;
    }

    .pill{
      margin-top:4px;
      padding:7px 11px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.08);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
      opacity:.9;
    }

    h1{
      font-family:"Luckiest Guy", cursive;
      font-size: clamp(26px, 4vw, 44px);
      letter-spacing:.02em;
      text-shadow: 0 4px 14px rgba(0,0,0,.45);
      line-height:1.0;
      margin-top:2px;
    }

    .sub{
      margin-top:10px;
      color: var(--muted);
      line-height:1.45;
      max-width: 720px;
      font-size:15px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.08);
      color: #eaf2ff;
      text-decoration:none;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.12); }
    .btn:active{ transform: translateY(0); box-shadow: 0 8px 16px rgba(0,0,0,.22); }
    .btn.primary{ background: rgba(120,180,255,.16); }
    .btn.primary:hover{ background: rgba(120,180,255,.22); }

    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 22px 18px;
      border-top: 1px solid rgba(255,255,255,.08);
    }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }
    .meta{
      margin-top:10px;
      padding: 0 22px 8px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      color: rgba(255,255,255,.70);
      font-size: 13px;
    }
    .meta code{ color: rgba(255,255,255,.78); }

    .content{
      padding: 12px 22px 22px;
    }

    .notice{
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      padding: 12px 14px;
      border-radius: 14px;
      margin-bottom: 14px;
      color: rgba(255,255,255,.80);
      font-size: 13px;
      line-height:1.4;
    }
    .notice strong{ color:#fff; }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .topbar{ flex-direction:column; }
      .controls{ flex-direction:column; align-items:stretch; }
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(255,255,255,.14);
      background: var(--panel2);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      display:flex;
      flex-direction:column;
      min-height: 280px;
    }

    /* THIS fixes the ‚Äúimage too huge‚Äù problem */
    .img{
      width:100%;
      height: 160px;             /* <‚Äî controls height */
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .img img{
      width:100%;
      height:100%;
      object-fit: cover;         /* <‚Äî crops nicely */
      display:block;
      filter: contrast(1.02);
    }

    .cardBody{
      padding: 12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
    }

    .name{
      font-weight: 900;
      font-size: 15px;
      letter-spacing:.01em;
    }
    .small{
      color: rgba(255,255,255,.70);
      font-size: 12px;
    }

    .row{
      margin-top:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .priceTag{
      padding: 6px 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.80);
      white-space:nowrap;
    }

    .err{
      color: #ffd1d1;
      border: 1px solid rgba(255,120,120,.25);
      background: rgba(255,0,0,.08);
    }

    .footerNote{
      padding: 14px 22px 18px;
      color: rgba(255,255,255,.65);
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
    }
  </style>
</head>

<body>
  <div class="texture"></div>

  <div class="wrap">
    <div class="shell">

      <div class="topbar">
        <div>
          <div class="titleRow">
            <div class="pill">Merch</div>
            <div>
              <h1>Intrigued Mutts Collection</h1>
              <div class="sub">
                Live storefront demo: pulls products from Printful and creates Square checkout links when you click <strong>Buy</strong>.
              </div>
            </div>
          </div>
        </div>

        <a class="btn" href="./index.html#mancave" aria-label="Back to clubhouse">Back to Clubhouse</a>
      </div>

      <div class="controls">
        <div class="search" role="search">
          <span style="opacity:.75">üîé</span>
          <input id="q" type="search" placeholder="Search products (ex: hoodie, shirt, mug)..." />
        </div>

        <button id="refresh" class="btn primary" type="button">Refresh products</button>
      </div>

      <div class="meta">
        <div id="status">Loading‚Ä¶</div>
        <div>API: <code id="apiLabel"></code></div>
      </div>

      <div class="content">
        <div id="notice" class="notice">
          <strong>Tip:</strong> If you see no items, it usually means Printful returned an empty list for your store (or the token has no store products).
        </div>

        <div id="grid" class="grid"></div>
      </div>

      <div class="footerNote">
        Next upgrades: real pricing, variants (sizes/colors), and a ‚ÄúCheckout‚Äù modal that feels like your brand.
      </div>

    </div>
  </div>

  <script>
    // ‚úÖ IMPORTANT: Your Worker base
    const API_BASE = "https://mutts-api.redavi19.workers.dev";
    document.getElementById("apiLabel").textContent = API_BASE;

    const grid = document.getElementById("grid");
    const statusEl = document.getElementById("status");
    const qEl = document.getElementById("q");

    let products = [];

    function setStatus(msg, isError=false){
      statusEl.textContent = msg;
      const notice = document.getElementById("notice");
      notice.classList.toggle("err", !!isError);
      if (isError) notice.innerHTML = "<strong>Heads up:</strong> " + msg;
      else notice.innerHTML = "<strong>Tip:</strong> If you see no items, it usually means Printful returned an empty list for your store (or the token has no store products).";
    }

    function moneyCentsToUSD(cents){
      const n = Number(cents || 0);
      return "$" + (n / 100).toFixed(2);
    }

    function render(list){
      grid.innerHTML = "";

      if (!list.length){
        grid.innerHTML = `
          <div class="card" style="grid-column: 1 / -1; min-height: 140px;">
            <div class="cardBody">
              <div class="name">No products found</div>
              <div class="small">Hit ‚ÄúRefresh products‚Äù to pull again. If it stays empty, your Printful token/store is the issue.</div>
            </div>
          </div>
        `;
        return;
      }

      for (const p of list){
        const card = document.createElement("div");
        card.className = "card";

        const imgUrl = p.thumbnail_url || "";

        // NOTE: price is placeholder until we wire real Printful variant pricing.
        // For now it‚Äôs just to test Square checkout.
        const testPriceCents = 2000;

        card.innerHTML = `
          <div class="img">
            ${imgUrl ? `<img src="${imgUrl}" alt="${(p.name||"Product").replace(/"/g,"&quot;")}" />` : `<div class="small">No preview</div>`}
          </div>
          <div class="cardBody">
            <div class="name">${p.name || "Item"}</div>
            <div class="small">product id: ${p.id ?? "-"}</div>

            <div class="row">
              <div class="priceTag">Test price: ${moneyCentsToUSD(testPriceCents)}</div>
              <button class="btn primary" type="button">Buy</button>
            </div>
          </div>
        `;

        const btn = card.querySelector("button");
        btn.addEventListener("click", async () => {
          btn.disabled = true;
          btn.textContent = "Creating link‚Ä¶";
          try{
            const res = await fetch(API_BASE + "/api/checkout/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name: p.name || "Item", amount: testPriceCents })
            });
            const data = await res.json();

            // Square response can include payment_link.url
            const payUrl =
              data?.payment_link?.url ||
              data?.payment_link?.long_url ||
              data?.url ||
              null;

            if (!payUrl) throw new Error("No checkout URL returned.");

            window.open(payUrl, "_blank", "noopener,noreferrer");
          }catch(e){
            alert("Checkout error: " + (e?.message || e));
          }finally{
            btn.disabled = false;
            btn.textContent = "Buy";
          }
        });

        grid.appendChild(card);
      }
    }

    function filterAndRender(){
      const q = (qEl.value || "").trim().toLowerCase();
      if (!q) return render(products);
      const filtered = products.filter(p => (p.name || "").toLowerCase().includes(q));
      render(filtered);
    }

    async function loadProducts(){
      setStatus("Loading products‚Ä¶");
      try{
        const res = await fetch(API_BASE + "/api/store/products");
        const data = await res.json();

        // Printful returns { code, result, ... }
        products = Array.isArray(data?.result) ? data.result : [];

        setStatus(`Loaded ${products.length} product(s). Click Buy to test checkout.`);
        filterAndRender();
      }catch(e){
        setStatus("Could not load products. Check API URL or Worker logs.", true);
        render([]);
      }
    }

    document.getElementById("refresh").addEventListener("click", loadProducts);
    qEl.addEventListener("input", filterAndRender);

    // initial load
    loadProducts();
  </script>
</body>
</html>
