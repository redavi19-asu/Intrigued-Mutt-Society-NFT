<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Success • Intrigued Mutts</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">

  <style>
    html,body{
      margin:0;
      font-family:system-ui;
      background:linear-gradient(rgba(0,0,0,.78),rgba(0,0,0,.78)),url('merchbackground.png') center/cover no-repeat fixed;
      color:#fff;
    }
    .wrap{max-width:980px;margin:0 auto;padding:26px}
    .brand{font-family:"Luckiest Guy", system-ui; font-size:34px; letter-spacing:1px; margin:0 0 6px}
    .sub{color:#b7c7ff;margin:0 0 18px}
    .card{
      border:1px solid #2a2a2a;
      background:rgba(17,17,17,0.55);
      backdrop-filter: blur(10px);
      border-radius:16px;
      padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.65);
    }
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .pill{
      display:inline-block;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #3aa0ff;
      box-shadow:0 0 16px rgba(58,160,255,.35);
      background:rgba(58,160,255,0.08);
      font-weight:700;
      margin:8px 0 0;
    }
    .label{color:#9aa3b2;font-size:12px;margin-top:14px}
    .value{font-size:15px;margin:4px 0 0;white-space:pre-wrap}
    .btn{
      background:transparent;
      border:1px solid #3aa0ff;
      padding:12px 18px;
      border-radius:12px;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      transition:all .2s ease;
      box-shadow:0 0 16px rgba(58,160,255,0.45);
      text-decoration:none;
      display:inline-block;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 0 24px rgba(58,160,255,0.8);background:rgba(58,160,255,0.08)}
    .btn:active{transform:translateY(0)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:#c9d4ff}
    .err{border-color:#ff4d6d; box-shadow:0 0 18px rgba(255,77,109,.25)}
    .ok{border-color:#2cff88; box-shadow:0 0 18px rgba(44,255,136,.18)}
    .spin{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,.25);
      border-top-color:#fff;
      display:inline-block;
      animation:rot 1s linear infinite;
      vertical-align:-4px;
      margin-right:8px;
    }
    @keyframes rot { to { transform:rotate(360deg);} }
  </style>
</head>

<body>
  <div class="wrap">
    <h1 class="brand">Intrigued Mutts Society</h1>
    <p class="sub">Payment receipt</p>

    <div id="box" class="card">
      <div id="statusLine" class="pill"><span class="spin"></span>Finalizing your payment...</div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:260px">
          <div class="label">Order ID</div>
          <div id="orderId" class="value mono">—</div>

          <div class="label">Payment Status</div>
          <div id="payStatus" class="value">—</div>

          <div class="label">Amount</div>
          <div id="amount" class="value">—</div>
        </div>

        <div style="flex:1;min-width:260px">
          <div class="label">Buyer Email</div>
          <div id="buyerEmail" class="value">—</div>

          <div class="label">Ship To</div>
          <div id="shipTo" class="value">—</div>

          <div class="label">Item</div>
          <div id="itemName" class="value">—</div>
        </div>
      </div>

      <div class="label">Raw (for debugging)</div>
      <div id="raw" class="value mono" style="max-height:220px; overflow:auto; border:1px solid #2a2a2a; padding:10px; border-radius:12px; background:rgba(0,0,0,.25)"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
        <a class="btn" href="./merch.html">← Back to Merch</a>
        <a class="btn" href="./index.html#mancave">← Back to Clubhouse</a>
      </div>

      <div style="margin-top:16px;font-size:12px;color:#ff69b4">
        © 2026 Intrigued Mutts Society. All rights reserved.
      </div>
    </div>
  </div>

<script>
  // MUST match your merch.html settings
  const PAYPAL_WORKER_BASE = "https://mutts-paypal.ryanedavis.workers.dev";
  const API_KEY = "mutts_api_7f3a91c2b8e4d0aa55c9"; // (works for now; later we'll hide it)

  // Optional: pass item name through return URL like ?item=...
  const qs = new URLSearchParams(location.search);
  const token = qs.get("token"); // PayPal order ID comes back as "token"
  const item = qs.get("item");

  const el = (id) => document.getElementById(id);

  function setStatus(text, ok=null){
    el("statusLine").innerHTML = (ok === null)
      ? `<span class="spin"></span>${text}`
      : text;

    const box = el("box");
    box.classList.remove("ok","err");
    if (ok === true) box.classList.add("ok");
    if (ok === false) box.classList.add("err");
  }

  function safe(obj, path, fallback="—"){
    try {
      return path.split(".").reduce((a,k)=>a?.[k], obj) ?? fallback;
    } catch { return fallback; }
  }

  function formatShip(capture){
    const ship = capture?.purchase_units?.[0]?.shipping;
    if (!ship) return "—";
    const name = ship?.name?.full_name || "";
    const a = ship?.address || {};
    const line1 = a.address_line_1 || "";
    const city = a.admin_area_2 || "";
    const st = a.admin_area_1 || "";
    const zip = a.postal_code || "";
    const country = a.country_code || "";
    return `${name}\n${line1}\n${city}, ${st} ${zip}\n${country}`.trim();
  }

  function formatAmount(capture){
    const cap = capture?.purchase_units?.[0]?.payments?.captures?.[0];
    const currency = cap?.amount?.currency_code;
    const value = cap?.amount?.value;
    if (!currency || !value) return "—";
    return `${currency} ${value}`;
  }

  async function captureNow(orderId){
    setStatus("Finalizing your payment...", null);
    el("orderId").textContent = orderId || "—";
    if (item) el("itemName").textContent = decodeURIComponent(item);

    if (!orderId){
      setStatus("Missing PayPal token in the URL.", false);
      el("raw").textContent = "No token found. Expected ?token=ORDER_ID";
      return;
    }

    const res = await fetch(`${PAYPAL_WORKER_BASE}/paypal/capture`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-KEY": API_KEY,
      },
      body: JSON.stringify({ orderId })
    });

    const data = await res.json().catch(()=>({ ok:false, error:"Bad JSON"}));

    if (!res.ok || !data.ok){
      setStatus("Payment capture failed.", false);
      el("payStatus").textContent = "FAILED";
      el("raw").textContent = JSON.stringify(data, null, 2);
      return;
    }

    const capture = data.capture;

    setStatus("Payment completed ✅", true);
    el("payStatus").textContent = capture?.status || "COMPLETED";
    el("buyerEmail").textContent = safe(capture, "payer.email_address", safe(capture, "payment_source.paypal.email_address", "—"));
    el("shipTo").textContent = formatShip(capture);
    el("amount").textContent = formatAmount(capture);

    // If you didn't pass item in URL, try best guess (not always present in PayPal data)
    if (!item) el("itemName").textContent = safe(capture, "purchase_units.0.description", "—");

    el("raw").textContent = JSON.stringify(data, null, 2);
  }

  captureNow(token);
</script>
</body>
</html>
