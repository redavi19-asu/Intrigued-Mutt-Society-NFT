<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Success • Intrigued Mutts</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">

  <style>
    html,body{
      margin:0;
      font-family:system-ui;
      background:linear-gradient(rgba(0,0,0,.78),rgba(0,0,0,.78)),url('merchbackground.png') center/cover no-repeat fixed;
      color:#fff;
    }
    .wrap{max-width:980px;margin:0 auto;padding:26px}
    .brand{font-family:"Luckiest Guy", system-ui; font-size:34px; letter-spacing:1px; margin:0 0 6px}
    .sub{color:#b7c7ff;margin:0 0 18px}
    .card{
      border:1px solid #2a2a2a;
      background:rgba(17,17,17,0.55);
      backdrop-filter: blur(10px);
      border-radius:16px;
      padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.65);
    }
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .pill{
      display:inline-block;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #3aa0ff;
      box-shadow:0 0 16px rgba(58,160,255,.35);
      background:rgba(58,160,255,0.08);
      font-weight:800;
      margin:8px 0 0;
    }
    .label{color:#9aa3b2;font-size:12px;margin-top:14px}
    .value{font-size:15px;margin:4px 0 0;white-space:pre-wrap}
    .btn{
      background:transparent;
      border:1px solid #3aa0ff;
      padding:12px 18px;
      border-radius:12px;
      color:#fff;
      font-weight:900;
      cursor:pointer;
      transition:all .2s ease;
      box-shadow:0 0 16px rgba(58,160,255,0.45);
      text-decoration:none;
      display:inline-block;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 0 24px rgba(58,160,255,0.8);background:rgba(58,160,255,0.08)}
    .btn:active{transform:translateY(0)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:#c9d4ff}
    .err{border-color:#ff4d6d; box-shadow:0 0 18px rgba(255,77,109,.25)}
    .ok{border-color:#2cff88; box-shadow:0 0 18px rgba(44,255,136,.18)}
    .spin{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,.25);
      border-top-color:#fff;
      display:inline-block;
      animation:rot 1s linear infinite;
      vertical-align:-4px;
      margin-right:8px;
    }
    @keyframes rot { to { transform:rotate(360deg);} }

    /* Cart receipt list */
    .items{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .item{
      display:grid;grid-template-columns:72px 1fr auto;
      gap:12px;align-items:center;
      border:1px solid #2a2a2a;border-radius:14px;
      background:rgba(0,0,0,.25);
      padding:10px;
    }
    .item img{width:72px;height:72px;border-radius:12px;object-fit:cover;border:1px solid #333}
    .iname{font-weight:900}
    .imeta{font-size:12px;color:#aaa;margin-top:4px}
    .iprice{font-weight:900;text-align:right}
    .totalsBox{
      margin-top:12px;border-top:1px solid #2a2a2a;padding-top:12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    }
    details{margin-top:14px}
    summary{cursor:pointer;color:#b7c7ff;font-weight:800}
    .rawBox{max-height:240px;overflow:auto;border:1px solid #2a2a2a;padding:10px;border-radius:12px;background:rgba(0,0,0,.25)}
  </style>
</head>

<body>
  <div class="wrap">
    <h1 class="brand">Intrigued Mutts Society</h1>
    <p class="sub">Payment receipt</p>

    <div id="box" class="card">
      <div id="statusLine" class="pill"><span class="spin"></span>Finalizing your payment...</div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:260px">
          <div class="label">Order ID</div>
          <div id="orderId" class="value mono">—</div>

          <div class="label">Payment Status</div>
          <div id="payStatus" class="value">—</div>

          <div class="label">Paid Total</div>
          <div id="amount" class="value">—</div>
        </div>

        <div style="flex:1;min-width:260px">
          <div class="label">Buyer Email</div>
          <div id="buyerEmail" class="value">—</div>

          <div class="label">Ship To</div>
          <div id="shipTo" class="value">—</div>
        </div>
      </div>

      <div class="label">Items</div>
      <div id="items" class="items"></div>

      <div class="totalsBox">
        <div>
          <div class="label" style="margin-top:0">Subtotal</div>
          <div id="subTotal" class="value" style="margin-top:2px">—</div>
        </div>
        <div>
          <div class="label" style="margin-top:0">Total</div>
          <div id="grandTotal" class="value" style="margin-top:2px;font-weight:900">—</div>
        </div>
      </div>

      <details>
        <summary>Debug details (optional)</summary>
        <div class="rawBox mono" id="raw"></div>
      </details>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
        <a class="btn" href="./merch.html">← Back to Merch</a>
        <a class="btn" href="./index.html#mancave">← Back to Clubhouse</a>
      </div>

      <div style="margin-top:16px;font-size:12px;color:#ff69b4">
        © 2026 Intrigued Mutts Society. All rights reserved.
      </div>
    </div>
  </div>

<script>
  const PAYPAL_WORKER_BASE = "https://mutts-paypal.ryanedavis.workers.dev";
  const API_KEY = "mutts_api_7f3a91c2b8e4d0aa55c9";

  const qs = new URLSearchParams(location.search);
  const token = qs.get("token"); // PayPal orderId

  const el = (id) => document.getElementById(id);

  function setStatus(text, ok=null){
    el("statusLine").innerHTML = (ok === null)
      ? `<span class="spin"></span>${text}`
      : text;

    const box = el("box");
    box.classList.remove("ok","err");
    if (ok === true) box.classList.add("ok");
    if (ok === false) box.classList.add("err");
  }

  function formatShip(record){
    const ship = record?.shipping;
    if (!ship) return "—";
    const name = ship?.name || "";
    const a = ship?.address || {};
    const line1 = a.address_line_1 || "";
    const city = a.admin_area_2 || "";
    const st = a.admin_area_1 || "";
    const zip = a.postal_code || "";
    const country = a.country_code || "";
    return `${name}\n${line1}\n${city}, ${st} ${zip}\n${country}`.trim();
  }

  function money(n){
    const v = Number(n || 0);
    return "$" + v.toFixed(2);
  }

  function renderItems(record){
    const items = record?.items || [];
    const box = el("items");
    box.innerHTML = "";

    if (!items.length){
      box.innerHTML = `<div style="padding:12px;border:1px dashed #444;border-radius:12px;color:#aaa">No item details found (cart not saved).</div>`;
      return;
    }

    items.forEach(it => {
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <img src="${it.imageUrl || ""}" alt="">
        <div>
          <div class="iname">${it.productName || "Item"}</div>
          <div class="imeta">${it.variantName || ""}</div>
          <div class="imeta">Unit: ${money(it.unitPrice)} • Qty: ${it.qty}</div>
        </div>
        <div class="iprice">${money(it.lineTotal)}</div>
      `;
      box.appendChild(row);
    });
  }

  async function captureNow(orderId){
    setStatus("Finalizing your payment...", null);
    el("orderId").textContent = orderId || "—";

    if (!orderId){
      setStatus("Missing PayPal token in the URL.", false);
      el("raw").textContent = "No token found. Expected ?token=ORDER_ID";
      return;
    }

    const res = await fetch(`${PAYPAL_WORKER_BASE}/paypal/capture`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-KEY": API_KEY,
      },
      body: JSON.stringify({ orderId })
    });

    const data = await res.json().catch(()=>({ ok:false, error:"Bad JSON"}));

    if (!res.ok || !data.ok){
      setStatus("Payment capture failed.", false);
      el("payStatus").textContent = "FAILED";
      el("raw").textContent = JSON.stringify(data, null, 2);
      return;
    }

    // NEW: we render from data.record (the KV receipt)
    const record = data.record || null;

    setStatus("Payment completed ✅", true);
    el("payStatus").textContent = record?.status || "COMPLETED";
    el("buyerEmail").textContent = record?.payer?.email || "—";
    el("shipTo").textContent = formatShip(record);

    const paid = record?.totals?.paidTotal || record?.totals?.total;
    const cur = record?.currency || "USD";
    el("amount").textContent = paid ? `${cur} ${paid}` : "—";

    el("subTotal").textContent = record?.totals?.subtotal ? `${cur} ${record.totals.subtotal}` : "—";
    el("grandTotal").textContent = record?.totals?.total ? `${cur} ${record.totals.total}` : "—";

    renderItems(record);

    // Debug (optional)
    el("raw").textContent = JSON.stringify(data, null, 2);

    // OPTIONAL: clear cart after success
    try { localStorage.removeItem("mutts_cart_v1"); } catch {}
  }

  captureNow(token);
</script>
</body>
</html>
